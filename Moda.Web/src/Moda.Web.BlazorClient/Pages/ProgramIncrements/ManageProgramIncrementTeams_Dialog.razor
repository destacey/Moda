@using System.ComponentModel.DataAnnotations;
@using Moda.Web.BlazorClient.Models.Common;
@using Moda.Web.BlazorClient.Models.Teams;

@implements IDisposable

@inject ISnackbar Snackbar
@inject IProgramIncrementsClient ProgramIncrementsClient
@inject ITeamsClient TeamsClient
@inject ITeamsOfTeamsClient TeamsOfTeamsClient

@if (_loading)
{
    <MudContainer>
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
    </MudContainer>
}
else
{
    <MudDialog>
        <DialogContent>
            <ModaSelect Label="Teams" IsMultiSelection="true" SelectViewModel="@_selectViewModel" />
        </DialogContent>
        <DialogActions>
            <MudButton OnClick="Cancel">Cancel</MudButton>
            <MudButton OnClick="Update" ButtonType="ButtonType.Submit" Color="Color.Primary" Variant="Variant.Filled" Disabled="@_saving">
                @if (_saving)
                {
                    <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                    <MudText Class="ms-2">Saving</MudText>
                }
                else
                {
                    <MudText>Save</MudText>
                }
            </MudButton>
        </DialogActions>
    </MudDialog>
}

@code {
    [CascadingParameter]
    MudDialogInstance MudDialog { get; set; } = default!;

    [Parameter]
    public Guid Id { get; set; } = default!;

    private SelectViewModel<Guid> _selectViewModel = new();

    private bool _loading = true;
    private bool _saving = false;

    protected override async Task OnInitializedAsync()
    {
        _loading = true;

        await SetProgramIncrementTeams();
        await SetTeamOptions();

        _loading = false;
    }

    private async Task SetProgramIncrementTeams()
    {
        if (await ApiHelper.ExecuteCallGuardedAsync(() => ProgramIncrementsClient.GetTeamsAsync(Id), Snackbar) is List<ProgramIncrementTeamResponse> result)
        {
            if (result.Any())
                _selectViewModel.SelectedValues = result.Select(t => t.Id).ToHashSet();
        }
    }

    private async Task SetTeamOptions()
    {
        var getTeams = ApiHelper.ExecuteCallGuardedAsync(() => TeamsClient.GetListAsync(false), Snackbar);
        var getTeamsOfTeams = ApiHelper.ExecuteCallGuardedAsync(() => TeamsOfTeamsClient.GetListAsync(false), Snackbar);

        await Task.WhenAll(getTeams, getTeamsOfTeams);

        List<BaseTeamViewModel> teams = new();
        if (getTeams.Result is List<TeamListDto> teamsResult)
        {
            teams.AddRange(teamsResult.Select(t => new BaseTeamViewModel(t)));
        }
        if (getTeamsOfTeams.Result is List<TeamOfTeamsListDto> teamOfTeamsResult)
        {
            teams.AddRange(teamOfTeamsResult.Select(t => new BaseTeamViewModel(t)));
        }

        _selectViewModel.Options = teams.Select(t => new SelectOptionsViewModel<Guid>(t.Id, t.Name)).ToList();
    }

    private void Cancel() => MudDialog.Cancel();

    private async Task Update()
    {
        _saving = true;

        try
        {
            var requestModel = new ManageProgramIncrementTeamsRequest
            {
                Id = Id,
                    TeamIds = _selectViewModel.SelectedValues.ToList()
            };
            await ProgramIncrementsClient.ManageTeamsAsync(Id, requestModel);

            Snackbar.Add("Program increment teams updated", MudBlazor.Severity.Success);

            MudDialog.Close(DialogResult.Ok(true));
        }
        catch (ApiException<ErrorResult> ex)
        {
            ErrorResult error = ex.Result;
            Snackbar.Add($"Error updating program increment teams. {error.SupportMessage}", MudBlazor.Severity.Error);
        }
        catch (Exception)
        {
            Snackbar.Add("Error updating program increment teams.", MudBlazor.Severity.Error);
        }

        _saving = false;
    }

    public void Dispose()
    {
    }
}
